FROM kasmweb/core-ubuntu-bionic:1.10.0
USER root

ENV HOME /home/kasm-default-profile
ENV STARTUPDIR /dockerstartup
ENV INST_SCRIPTS $STARTUPDIR/install
WORKDIR $HOME

# Install VSCode
RUN apt update && apt install git -y
RUN git clone https://github.com/kasmtech/workspaces-images.git
RUN cp -r workspaces-images/src/ubuntu/install/vs_code $INST_SCRIPTS/
RUN bash $INST_SCRIPTS/install_vs_code.sh

# Install Google Chrome
RUN cp -r ./workspaces-images/src/ubuntu/install/chrome $INST_SCRIPTS/chrome/
RUN bash $INST_SCRIPTS/chrome/install_chrome.sh  && rm -rf $INST_SCRIPTS/chrome/
RUN rm -rf ./workspaces-images

RUN chown 1000:0 $HOME
RUN $STARTUPDIR/set_user_permission.sh $HOME

# Updates and packages
RUN apt update && apt upgrade -y && apt install sudo unzip firefox -y && apt install --only-upgrade libzmq5 -y
RUN apt remove libzmq5 -y

# Install python3
RUN apt install python3.8 -y \
    && apt-get -y install python3-pip \
    && apt-get -y install python3.8-venv \
    && update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.8 1

# Install pip packages
RUN pip3 install autopep8==1.6.0 \
    && pip3 install bandit==1.7.4 \
    && pip3 install black==22.6.0 \
    && pip3 install flake8==4.0.1 \
    && pip3 install pathspec==0.9.0 \
    && pip3 install pre-commit==2.20.0 \
    && pip3 install pycodestyle==2.8.0 \
    && pip3 install pydocstyle==6.1.1 \
    && pip3 install pylint==2.14.4 \
    && pip3 install yapf==0.32.0 \
    && pip3 install mypy==0.961 --default-timeout=100 \
    && apt install python3-setuptools \
    && pip3 install -U pip setuptools \
    && pip3 install dbt-snowflake==1.3.0 \
    && pip3 install elementary-data==0.6.2 \
    && pip3 install elementary-data[snowflake]==0.6.2 \
    && pip3 install pyopenssl==23.0.0 \
    && pip3 install sqlfluff==1.3.2 \
    && pip3 install sqlfluff-templater-dbt==1.3.2 \
    && pip3 install snowflake-connector-python==2.8.2 \
    && pip3 install cryptography==39.0.1 \ 
    && pip3 install werkzeug==2.2.3

# Add persistent bin directory & setup cli
RUN mkdir $HOME/.dbt $HOME/.ssh $HOME/.aws $HOME/.snowsql $HOME/bin
RUN cp /etc/skel/.bashrc $HOME
RUN echo 'export PATH="$HOME/bin:$PATH"' >> $HOME/.bashrc

# Install tfswitch
RUN wget https://raw.githubusercontent.com/warrensbox/terraform-switcher/release/install.sh
RUN chmod 755 install.sh
RUN ./install.sh -b /usr/bin
RUN rm install.sh

# Install SnowSQL
RUN apt-get install alien -y
RUN wget https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.2/linux_x86_64/snowflake-snowsql-1.2.17-1.x86_64.rpm -O snowsql.rpm
RUN alien -i snowsql.rpm
RUN touch /home/snowsql_rt.log_bootstrap
RUN chmod a+w /home/snowsql_rt.log_bootstrap

# Cleanup
RUN apt-get autoclean
RUN apt-get autoremove -y

# Finalize user setup
RUN groupadd 1000
ENV HOME /home/kasm-user
WORKDIR $HOME
RUN mkdir -p $HOME && chown -R 1000:0 $HOME

RUN echo 'kasm   ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers \
    && echo 'kasm:x:1000:1000::/home/kasm-user:/bin/bash' >> /etc/passwd

USER kasm
